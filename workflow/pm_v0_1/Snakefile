import hashlib
import json
import pathlib
import yaml
import pandas as pd
import datetime

configfile: "config.yaml"

PHAGE_MANIFEST = pathlib.Path(config["manifests"]["phages"])
HOST_MANIFEST = pathlib.Path(config["manifests"]["hosts"])
CACHE_DIR = pathlib.Path(config["directories"]["cache"])
RESULTS_DIR = pathlib.Path(config["directories"]["results"])
TEST_MODE = config["modules"].get("test_mode", False)

phages_df = pd.read_csv(PHAGE_MANIFEST, sep="\t") if PHAGE_MANIFEST.exists() else pd.DataFrame(columns=["phage_id","fasta"])
hosts_df = pd.read_csv(HOST_MANIFEST, sep="\t") if HOST_MANIFEST.exists() else pd.DataFrame(columns=["host_id","genome_fna","proteome_faa"])
PHAGE_IDS = phages_df["phage_id"].tolist()
HOST_IDS = hosts_df["host_id"].tolist()


def sha256_file(path: pathlib.Path):
    if not path.exists():
        return None
    h = hashlib.sha256()
    with path.open("rb") as f:
        for chunk in iter(lambda: f.read(8192), b""):
            h.update(chunk)
    return h.hexdigest()


def iso_now():
    return datetime.datetime.now(datetime.timezone.utc).isoformat()

rule all:
    input:
        expand(RESULTS_DIR / "{host_id}" / "ranking.csv", host_id=HOST_IDS),
        expand(RESULTS_DIR / "{host_id}" / "evidence_bundle.json", host_id=HOST_IDS)

rule mock_structures:
    input:
        phage_fasta=lambda wildcards: phages_df.set_index("phage_id").loc[wildcards.phage_id, "fasta"] if not phages_df.empty else "missing",
        host_fasta=lambda wildcards: hosts_df.set_index("host_id").loc[wildcards.host_id, "genome_fna"] if not hosts_df.empty else "missing"
    output:
        CACHE_DIR / "phages" / "{phage_id}" / "mock" / "structures" / "{phage_id}.pdb",
        CACHE_DIR / "hosts" / "{host_id}" / "mock" / "structures" / "{host_id}.pdb"
    run:
        for path in output:
            pathlib.Path(path).parent.mkdir(parents=True, exist_ok=True)
            pathlib.Path(path).write_text(f"MOCK {pathlib.Path(path).stem}\n")

rule aggregate_rankings:
    input:
        mocks=expand(CACHE_DIR / "phages" / "{phage_id}" / "mock" / "structures" / "{phage_id}.pdb", phage_id=PHAGE_IDS),
        host_mock=lambda wildcards: CACHE_DIR / "hosts" / wildcards.host_id / "mock" / "structures" / f"{wildcards.host_id}.pdb"
    output:
        ranking=RESULTS_DIR / "{host_id}" / "ranking.csv",
        evidence=RESULTS_DIR / "{host_id}" / "evidence_bundle.json"
    run:
        out_dir = pathlib.Path(output.ranking).parent
        out_dir.mkdir(parents=True, exist_ok=True)
        # Simple deterministic mock ranking for all phages
        rows = [{"phage_id": pid, "score": 1.0} for pid in PHAGE_IDS]
        ranking_df = pd.DataFrame(rows if rows else [{"phage_id": "none", "score": 0.0}])
        ranking_df.to_csv(output.ranking, index=False)

        # Evidence bundle with reproducibility metadata
        evidence = {
            "mock": bool(TEST_MODE),
            "run_id": iso_now(),
            "test_mode": bool(TEST_MODE),
            "config_hash": sha256_file(pathlib.Path("config.yaml")),
            "manifest_hashes": {
                "phages": sha256_file(PHAGE_MANIFEST),
                "hosts": sha256_file(HOST_MANIFEST),
            },
        }
        with pathlib.Path(output.evidence).open("w") as f:
            json.dump(evidence, f)
